name: Secret Scan

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  scan:
    name: Scan repository for secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run secret scan (capture output)
        id: run-scan
        continue-on-error: true
        run: |
          chmod +x ./scripts/scan-secrets.sh
          ./scripts/scan-secrets.sh 2>&1 | tee secret-scan-report.txt

      - name: Upload secret scan report
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-report
          path: secret-scan-report.txt

      - name: Create issue if secrets found
        if: ${{ steps.run-scan.conclusion == 'failure' }}
        uses: peter-evans/create-issue@v4
        with:
          title: "[SECURITY] Secret scan detected potential secrets"
          body: |
            The automated secret scanner detected potential secrets in this branch. Please review the attached `secret-scan-report` artifact in the workflow run for details, remove any committed secrets, and rotate affected credentials.
            
            Steps to remediate:
            1. Remove secret-containing files from the repo and add them to `.gitignore`.
            2. Rotate any exposed credentials immediately (JWT_SECRET, admin passwords, API keys).
            3. Re-run the secret scanner locally with `npm run scan:secrets`.
            
            This issue was created automatically by the secret-scan GitHub Actions workflow.
          assignees: ''
          labels: 'security,secret-scan'

      - name: Fail if secrets found
        if: ${{ steps.run-scan.conclusion == 'failure' }}
        run: |
          echo "Secrets detected by scanner; failing job. See artifact 'secret-scan-report' for details."
          exit 1
